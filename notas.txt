@RestResource(urlMapping='/messaging/context/*')
global class MessagingContextAPI {
    
    @HttpPost
    global static Response saveContext() {
        try {
            RestRequest req = RestContext.request;
            String body = req.requestBody.toString();
            Map<String, Object> params = (Map<String, Object>) JSON.deserializeUntyped(body);
            
            String sessionId = (String) params.get('sessionId');
            String pageTitle = (String) params.get('pageTitle');
            String pageURL = (String) params.get('pageURL');
            String userLanguage = (String) params.get('userLanguage');
            String referrer = (String) params.get('referrer');
            
            List<MessagingSession> sessions = [
                SELECT Id, Page_Title__c, Page_URL__c, User_Language__c
                FROM MessagingSession
                WHERE Id = :sessionId
                LIMIT 1
            ];
            
            if (sessions.isEmpty()) {
                return new Response(false, 'MessagingSession not found: ' + sessionId, null);
            }
            
            MessagingSession ms = sessions[0];
            ms.Page_Title__c = pageTitle;
            ms.Page_URL__c = pageURL;
            ms.User_Language__c = userLanguage;
            
            update ms;
            
            return new Response(true, 'Context saved successfully', sessionId);
            
        } catch (Exception e) {
            return new Response(false, 'Error: ' + e.getMessage(), null);
        }
    }
    
    global class Response {
        global Boolean success;
        global String message;
        global String sessionId;
        
        global Response(Boolean success, String message, String sessionId) {
            this.success = success;
            this.message = message;
            this.sessionId = sessionId;
        }
    }
}