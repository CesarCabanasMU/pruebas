// ===== OPCIÓN 2: PLATFORM EVENT =====

// 1. Crear Platform Event en Salesforce:
//    Setup → Platform Events → New Platform Event
//    API Name: Messaging_Context__e
//    Fields:
//      - Session_Id__c (Text, 18)
//      - Page_Title__c (Text, 255)
//      - Page_URL__c (Text, 255)
//      - User_Language__c (Text, 50)

// 2. Trigger que escucha el Platform Event:

trigger MessagingContextEventTrigger on Messaging_Context__e (after insert) {
    List<MessagingSession> sessionsToUpdate = new List<MessagingSession>();
    Set<Id> sessionIds = new Set<Id>();
    
    for (Messaging_Context__e event : Trigger.new) {
        if (event.Session_Id__c != null) {
            sessionIds.add(event.Session_Id__c);
        }
    }
    
    if (!sessionIds.isEmpty()) {
        Map<Id, MessagingSession> sessionMap = new Map<Id, MessagingSession>([
            SELECT Id, Page_Title__c, Page_URL__c, User_Language__c
            FROM MessagingSession
            WHERE Id IN :sessionIds
        ]);
        
        for (Messaging_Context__e event : Trigger.new) {
            MessagingSession ms = sessionMap.get(event.Session_Id__c);
            if (ms != null) {
                ms.Page_Title__c = event.Page_Title__c;
                ms.Page_URL__c = event.Page_URL__c;
                ms.User_Language__c = event.User_Language__c;
                sessionsToUpdate.add(ms);
            }
        }
        
        if (!sessionsToUpdate.isEmpty()) {
            update sessionsToUpdate;
        }
    }
}

// ===== OPCIÓN 3: APEX REST SERVICE =====

// Crear Apex REST que reciba los datos desde JavaScript:

@RestResource(urlMapping='/messaging/context/*')
global class MessagingContextService {
    
    @HttpPost
    global static String receiveContext() {
        RestRequest req = RestContext.request;
        Map<String, Object> params = (Map<String, Object>) JSON.deserializeUntyped(req.requestBody.toString());
        
        String sessionId = (String) params.get('sessionId');
        String pageTitle = (String) params.get('pageTitle');
        String pageURL = (String) params.get('pageURL');
        String userLanguage = (String) params.get('userLanguage');
        
        try {
            MessagingSession ms = [
                SELECT Id, Page_Title__c, Page_URL__c, User_Language__c
                FROM MessagingSession
                WHERE Id = :sessionId
                LIMIT 1
            ];
            
            ms.Page_Title__c = pageTitle;
            ms.Page_URL__c = pageURL;
            ms.User_Language__c = userLanguage;
            
            update ms;
            
            return JSON.serialize(new Map<String, Object>{
                'success' => true,
                'message' => 'Context saved successfully'
            });
        } catch (Exception e) {
            return JSON.serialize(new Map<String, Object>{
                'success' => false,
                'error' => e.getMessage()
            });
        }
    }
}